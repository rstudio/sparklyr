<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Using sparklyr with an Apache Spark cluster â€¢ sparklyr</title>
<!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://maxcdn.bootstrapcdn.com/bootswatch/3.3.7/cosmo/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
<!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../jquery.sticky-kit.min.js"></script><script src="../pkgdown.js"></script><!-- mathjax --><script src="https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-vignette">
      <header><div class="navbar navbar-inverse navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="../index.html">sparklyr</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">Home</a>
</li>
<li>
  <a href="../articles/gallery.html">Gallery</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Guides
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/guides-dplyr.html">dplyr</a>
    </li>
    <li>
      <a href="../articles/guides-mllib.html">mllib</a>
    </li>
    <li>
      <a href="../articles/guides-distributed-r.html">Distributed R</a>
    </li>
    <li>
      <a href="../articles/guides-extensions.html">Extensions</a>
    </li>
    <li>
      <a href="../articles/guides-caching.html">Caching</a>
    </li>
    <li>
      <a href="../articles/guides-h2o.html">H2O</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Deployment
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/deployment-overview.html">Overview</a>
    </li>
    <li>
      <a href="../articles/deployment-data-lakes.html">Data Lakes</a>
    </li>
    <li>
      <a href="../articles/deployment-cdh.html">Cloudera</a>
    </li>
    <li>
      <a href="../articles/deployment-amazon.html">Amazon</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Reference
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../reference/index.html">Functions</a>
    </li>
    <li>
      <a href="https://github.com/rstudio/cheatsheets/raw/master/source/pdfs/sparklyr-cheatsheet.pdf">Cheatsheet</a>
    </li>
    <li>
      <a href="../articles/reference-media.html">Media</a>
    </li>
    <li>
      <a href="../news/index.html">News</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/rstudio/sparklyr">
    <span class="fa fa-github"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9">
    <div class="page-header toc-ignore">
      <h1>Using sparklyr with an Apache Spark cluster</h1>
            
          </div>

    
    
<div class="contents">
<p>This document demonstrates how to use <code>sparklyr</code> with an Apache Spark cluster. Data are downloaded from the web and stored in Hive tables on HDFS across multiple worker nodes. RStudio Server is installed on the master node and orchestrates the analysis in spark. Here is the basic workflow.</p>
<p><img src="images/deployment/amazon-emr/workflowShare.png" width="600/"></p>
<div id="data-preparation" class="section level1">
<h1 class="hasAnchor">
<a href="#data-preparation" class="anchor"></a>Data preparation</h1>
<div id="set-up-the-cluster" class="section level2">
<h2 class="hasAnchor">
<a href="#set-up-the-cluster" class="anchor"></a>Set up the cluster</h2>
<p>This demonstration uses Amazon Web Services (AWS), but it could just as easily use Microsot, Google, or any other provider. We will use Elastic Map Reduce (EMR) to easily set up a cluster with two core nodes and one master node. Nodes use virtual servers from the Elastic Compute Cloud (EC2). <em>Note: There is no free tier for EMR, charges will apply.</em></p>
<p>Before beginning this setup we assume you have:</p>
<ul>
<li>Familiarity with and access to an AWS account</li>
<li>Familiarity with basic linux commands</li>
<li>Sudo privileges in order to install software from the command line</li>
</ul>
<p>
<img src="images/deployment/amazon-emr/emrArchitecture.png" width="600/"></p>
<div id="build-an-emr-cluster" class="section level3">
<h3 class="hasAnchor">
<a href="#build-an-emr-cluster" class="anchor"></a>Build an EMR cluster</h3>
<p>Before beginning the EMR wizard setup, make sure you create the following in AWS:</p>
<ul>
<li>An AWS key pair (.pem key) so you can SSH into the EC2 master node</li>
<li>A security group that gives you access to port 22 on your IP and port 8787 from anywhere</li>
</ul>
<p><img src="images/deployment/amazon-emr/awsNewSecurityGroup.png" width="600/"></p>
<hr>
<div id="step-1-select-software" class="section level4">
<h4 class="hasAnchor">
<a href="#step-1-select-software" class="anchor"></a>Step 1: Select software</h4>
<p>Make sure to select Hive and Spark as part of the install. Note that by choosing Spark, R will also be installed on the master node as part of the distribution.</p>
<p><img src="images/deployment/amazon-emr/emrConfigStep1.png" width="600/"></p>
<hr>
</div>
<div id="step-2-select-hardware" class="section level4">
<h4 class="hasAnchor">
<a href="#step-2-select-hardware" class="anchor"></a>Step 2: Select hardware</h4>
<p>Install 2 core nodes and one master node with m3.xlarge 80 GiB storage per node. You can easily increase the number of nodes later.</p>
<p><img src="images/deployment/amazon-emr/emrConfigStep2.png" width="600/"></p>
<hr>
</div>
<div id="step-3-select-general-cluster-settings" class="section level4">
<h4 class="hasAnchor">
<a href="#step-3-select-general-cluster-settings" class="anchor"></a>Step 3: Select general cluster settings</h4>
<p>Click next on the general cluster settings.</p>
<p><img src="images/deployment/amazon-emr/emrConfigStep3.png" width="600/"></p>
<hr>
</div>
<div id="step-4-select-security" class="section level4">
<h4 class="hasAnchor">
<a href="#step-4-select-security" class="anchor"></a>Step 4: Select security</h4>
<p>Enter your EC2 key pair and security group. Make sure the security group has ports 22 and 8787 open.</p>
<p><img src="images/deployment/amazon-emr/emrConfigStep4.png" width="600/"></p>
<hr>
</div>
</div>
<div id="connect-to-emr" class="section level3">
<h3 class="hasAnchor">
<a href="#connect-to-emr" class="anchor"></a>Connect to EMR</h3>
<p>The cluster page will give you details about your EMR cluster and instructions on connecting.</p>
<p><img src="images/deployment/amazon-emr/awsClusterConnect.png" width="600/"></p>
<p>Connect to the master node via SSH using your key pair. Once you connect you will see the EMR welcome.</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="co"># Log in to master node</span>
<span class="fu">ssh</span> -i ~/spark-demo.pem hadoop@ec2-52-10-102-11.us-west-2.compute.amazonaws.com</code></pre></div>
<p><img src="images/deployment/amazon-emr/emrLogin.png" width="600/"></p>
</div>
<div id="install-rstudio-server" class="section level3">
<h3 class="hasAnchor">
<a href="#install-rstudio-server" class="anchor"></a>Install RStudio Server</h3>
<p>EMR uses Amazon Linux which is based on Centos. Update your master node and install dependencies that will be used by R packages.</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="co"># Update</span>
<span class="fu">sudo</span> yum update
<span class="fu">sudo</span> yum install libcurl-devel openssl-devel <span class="co"># used for devtools</span></code></pre></div>
<p>The installation of RStudio Server is easy. Download the <a href="https://www.rstudio.com/products/rstudio/download/preview/">preview version</a> of RStudio and install on the master node.</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="co"># Install RStudio Server</span>
<span class="fu">wget</span> -P /tmp https://s3.amazonaws.com/rstudio-dailybuilds/rstudio-server-rhel-0.99.1266-x86_64.rpm
<span class="fu">sudo</span> yum install --nogpgcheck /tmp/rstudio-server-rhel-0.99.1266-x86_64.rpm</code></pre></div>
</div>
<div id="create-a-user" class="section level3">
<h3 class="hasAnchor">
<a href="#create-a-user" class="anchor"></a>Create a User</h3>
<p>Create a user called <code>rstudio-user</code> that will perform the data analysis. Create a user directory for <code>rstudio-user</code> on HDFS with the <code>hadoop fs</code> command.</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="co"># Make User</span>
<span class="fu">sudo</span> useradd -m rstudio-user
<span class="fu">sudo</span> passwd rstudio-user

<span class="co"># Create new directory in hdfs</span>
<span class="ex">hadoop</span> fs -mkdir /user/rstudio-user
<span class="ex">hadoop</span> fs -chmod 777 /user/rstudio-user</code></pre></div>
</div>
</div>
<div id="download-flights-data" class="section level2">
<h2 class="hasAnchor">
<a href="#download-flights-data" class="anchor"></a>Download flights data</h2>
<p>The <a href="http://stat-computing.org/dataexpo/2009/the-data.html">flights</a> data is a well known data source representing 123 million flights over 22 years. It consumes roughly 12 GiB of storage in uncompressed CSV format in yearly files.</p>
<div id="switch-user" class="section level4">
<h4 class="hasAnchor">
<a href="#switch-user" class="anchor"></a>Switch User</h4>
<p>For data loading and analysis, make sure you are logged in as regular user.</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="co"># create directories on hdfs for new user</span>
<span class="ex">hadoop</span> fs -mkdir /user/rstudio-user
<span class="ex">hadoop</span> fs -chmod 777 /user/rstudio-user

<span class="co"># switch user</span>
<span class="fu">su</span> rstudio-user</code></pre></div>
</div>
<div id="download-data" class="section level3">
<h3 class="hasAnchor">
<a href="#download-data" class="anchor"></a>Download data</h3>
<p>Run the following script to download data from the web onto your master node. Download the yearly flight data and the airlines lookup table.</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="co"># Make download directory</span>
<span class="fu">mkdir</span> /tmp/flights

<span class="co"># Download flight data by year</span>
<span class="kw">for</span> <span class="ex">i</span> in <span class="dt">{1987..2008}</span>
  <span class="kw">do</span>
    <span class="bu">echo</span> <span class="st">"</span><span class="va">$(</span><span class="fu">date</span><span class="va">)</span><span class="st"> </span><span class="va">$i</span><span class="st"> Download"</span>
    <span class="va">fnam=$i</span>.csv.bz2
    <span class="fu">wget</span> -O /tmp/flights/<span class="va">$fnam</span> http://stat-computing.org/dataexpo/2009/<span class="va">$fnam</span>
    <span class="bu">echo</span> <span class="st">"</span><span class="va">$(</span><span class="fu">date</span><span class="va">)</span><span class="st"> </span><span class="va">$i</span><span class="st"> Unzip"</span>
    <span class="fu">bunzip2</span> /tmp/flights/<span class="va">$fnam</span>
  <span class="kw">done</span>

<span class="co"># Download airline carrier data</span>
<span class="fu">wget</span> -O /tmp/airlines.csv http://www.transtats.bts.gov/Download_Lookup.asp?Lookup=L_UNIQUE_CARRIERS

<span class="co"># Download airports data</span>
<span class="fu">wget</span> -O /tmp/airports.csv https://raw.githubusercontent.com/jpatokal/openflights/master/data/airports.dat</code></pre></div>
</div>
<div id="distribute-into-hdfs" class="section level3">
<h3 class="hasAnchor">
<a href="#distribute-into-hdfs" class="anchor"></a>Distribute into HDFS</h3>
<p>Copy data into HDFS using the <code>hadoop fs</code> command.</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="co"># Copy flight data to HDFS</span>
<span class="ex">hadoop</span> fs -mkdir /user/rstudio-user/flights/
<span class="ex">hadoop</span> fs -put /tmp/flights /user/rstudio-user/

<span class="co"># Copy airline data to HDFS</span>
<span class="ex">hadoop</span> fs -mkdir /user/rstudio-user/airlines/
<span class="ex">hadoop</span> fs -put /tmp/airlines.csv /user/rstudio-user/airlines

<span class="co"># Copy airport data to HDFS</span>
<span class="ex">hadoop</span> fs -mkdir /user/rstudio-user/airports/
<span class="ex">hadoop</span> fs -put /tmp/airports.csv /user/rstudio-user/airports</code></pre></div>
</div>
</div>
<div id="create-hive-tables" class="section level2">
<h2 class="hasAnchor">
<a href="#create-hive-tables" class="anchor"></a>Create Hive tables</h2>
<p>Launch Hive from the command line.</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="co"># Open Hive prompt</span>
<span class="ex">hive</span></code></pre></div>
<p>Create the metadata that will structure the flights table. Load data into the Hive table.</p>
<div class="sourceCode"><pre class="sourceCode sql"><code class="sourceCode sql"># <span class="kw">Create</span> metadata <span class="kw">for</span> flights
<span class="kw">CREATE</span> EXTERNAL <span class="kw">TABLE</span> <span class="kw">IF</span> <span class="kw">NOT</span> <span class="kw">EXISTS</span> flights
(
<span class="dt">year</span> <span class="dt">int</span>,
<span class="dt">month</span> <span class="dt">int</span>,
dayofmonth <span class="dt">int</span>,
dayofweek <span class="dt">int</span>,
deptime <span class="dt">int</span>,
crsdeptime <span class="dt">int</span>,
arrtime <span class="dt">int</span>, 
crsarrtime <span class="dt">int</span>,
uniquecarrier string,
flightnum <span class="dt">int</span>,
tailnum string, 
actualelapsedtime <span class="dt">int</span>,
crselapsedtime <span class="dt">int</span>,
airtime string,
arrdelay <span class="dt">int</span>,
depdelay <span class="dt">int</span>, 
origin string,
dest string,
distance <span class="dt">int</span>,
taxiin string,
taxiout string,
cancelled <span class="dt">int</span>,
cancellationcode string,
diverted <span class="dt">int</span>,
carrierdelay string,
weatherdelay string,
nasdelay string,
securitydelay string,
lateaircraftdelay string
)
<span class="kw">ROW</span> FORMAT DELIMITED
FIELDS TERMINATED <span class="kw">BY</span> <span class="st">','</span>
LINES TERMINATED <span class="kw">BY</span> <span class="st">'</span><span class="ch">\n</span><span class="st">'</span>
TBLPROPERTIES(<span class="ot">"skip.header.line.count"</span>=<span class="ot">"1"</span>);

# Load <span class="kw">data</span> <span class="kw">into</span> <span class="kw">table</span>
LOAD <span class="kw">DATA</span> INPATH <span class="st">'/user/rstudio-user/flights'</span> <span class="kw">INTO</span> <span class="kw">TABLE</span> flights;</code></pre></div>
<p>Create the metadata that will structure the airlines table. Load data into the Hive table.</p>
<div class="sourceCode"><pre class="sourceCode sql"><code class="sourceCode sql"># <span class="kw">Create</span> metadata <span class="kw">for</span> airlines
<span class="kw">CREATE</span> EXTERNAL <span class="kw">TABLE</span> <span class="kw">IF</span> <span class="kw">NOT</span> <span class="kw">EXISTS</span> airlines
(
Code string,
Description string
)
<span class="kw">ROW</span> FORMAT SERDE <span class="st">'org.apache.hadoop.hive.serde2.OpenCSVSerde'</span>
<span class="kw">WITH</span> SERDEPROPERTIES
(
<span class="ot">"separatorChar"</span> = <span class="st">'\,'</span>,
<span class="ot">"quoteChar"</span>     = <span class="st">'</span><span class="ch">\"</span><span class="st">'</span>
)
STORED <span class="kw">AS</span> TEXTFILE
tblproperties(<span class="ot">"skip.header.line.count"</span>=<span class="ot">"1"</span>);

# Load <span class="kw">data</span> <span class="kw">into</span> <span class="kw">table</span>
LOAD <span class="kw">DATA</span> INPATH <span class="st">'/user/rstudio-user/airlines'</span> <span class="kw">INTO</span> <span class="kw">TABLE</span> airlines;</code></pre></div>
<p>Create the metadata that will structure the airports table. Load data into the Hive table.</p>
<div class="sourceCode"><pre class="sourceCode sql"><code class="sourceCode sql"># <span class="kw">Create</span> metadata <span class="kw">for</span> airports
<span class="kw">CREATE</span> EXTERNAL <span class="kw">TABLE</span> <span class="kw">IF</span> <span class="kw">NOT</span> <span class="kw">EXISTS</span> airports
(
<span class="kw">id</span> string,
name string,
city string,
country string,
faa string,
icao string,
lat <span class="dt">double</span>,
lon <span class="dt">double</span>,
alt <span class="dt">int</span>,
<span class="fu">tz_offset</span> <span class="dt">double</span>,
dst string,
tz_name string
)
<span class="kw">ROW</span> FORMAT SERDE <span class="st">'org.apache.hadoop.hive.serde2.OpenCSVSerde'</span>
<span class="kw">WITH</span> SERDEPROPERTIES
(
<span class="ot">"separatorChar"</span> = <span class="st">'\,'</span>,
<span class="ot">"quoteChar"</span>     = <span class="st">'</span><span class="ch">\"</span><span class="st">'</span>
)
STORED <span class="kw">AS</span> TEXTFILE;

# Load <span class="kw">data</span> <span class="kw">into</span> <span class="kw">table</span>
LOAD <span class="kw">DATA</span> INPATH <span class="st">'/user/rstudio-user/airports'</span> <span class="kw">INTO</span> <span class="kw">TABLE</span> airports;</code></pre></div>
</div>
<div id="connect-to-spark" class="section level2">
<h2 class="hasAnchor">
<a href="#connect-to-spark" class="anchor"></a>Connect to Spark</h2>
<p>Log in to RStudio Server by pointing a browser at your master node IP:8787.</p>
<p>
<img src="images/deployment/amazon-emr/rstudioLogin.png" width="600/"></p>
<p>Set the environment variable <code>SPARK_HOME</code> and then run <code>spark_connect</code>. After connecting you will be able to browse the Hive metadata in the RStudio Server Spark pane.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Connect to Spark</span>
<span class="kw">library</span>(sparklyr)
<span class="kw">library</span>(dplyr)
<span class="kw">library</span>(ggplot2)
<span class="kw">Sys.setenv</span>(<span class="dt">SPARK_HOME=</span><span class="st">"/usr/lib/spark"</span>)
config &lt;-<span class="st"> </span><span class="kw"><a href="../reference/spark_config.html">spark_config</a></span>()
sc &lt;-<span class="st"> </span><span class="kw"><a href="../reference/spark-connections.html">spark_connect</a></span>(<span class="dt">master =</span> <span class="st">"yarn-client"</span>, <span class="dt">config =</span> config, <span class="dt">version =</span> <span class="st">'1.6.2'</span>)</code></pre></div>
<p>Once you are connected, you will see the Spark pane appear along with your hive tables.</p>
<p>
<img src="images/deployment/amazon-emr/rstudioSparkPane.png" width="600/"></p>
<p>You can inspect your tables by clicking on the data icon.</p>
<p>
<img src="images/deployment/amazon-emr/rstudioData.png" width="600/"></p>
</div>
</div>
<div id="data-analysis" class="section level1">
<h1 class="hasAnchor">
<a href="#data-analysis" class="anchor"></a>Data analysis</h1>
<p>Is there evidence to suggest that some airline carriers make up time in flight? This analysis predicts time gained in flight by airline carrier.</p>
<p>
<img src="images/deployment/amazon-emr/rstudio.png" width="600/"></p>
<div id="cache-the-tables-into-memory" class="section level2">
<h2 class="hasAnchor">
<a href="#cache-the-tables-into-memory" class="anchor"></a>Cache the tables into memory</h2>
<p>Use <code>tbl_cache</code> to load the flights table into memory. Caching tables will make analysis much faster. Create a dplyr reference to the Spark DataFrame.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Cache flights Hive table into Spark</span>
<span class="kw"><a href="../reference/tbl_cache.html">tbl_cache</a></span>(sc, <span class="st">'flights'</span>)
flights_tbl &lt;-<span class="st"> </span><span class="kw">tbl</span>(sc, <span class="st">'flights'</span>)

<span class="co"># Cache airlines Hive table into Spark</span>
<span class="kw"><a href="../reference/tbl_cache.html">tbl_cache</a></span>(sc, <span class="st">'airlines'</span>)
airlines_tbl &lt;-<span class="st"> </span><span class="kw">tbl</span>(sc, <span class="st">'airlines'</span>)

<span class="co"># Cache airports Hive table into Spark</span>
<span class="kw"><a href="../reference/tbl_cache.html">tbl_cache</a></span>(sc, <span class="st">'airports'</span>)
airports_tbl &lt;-<span class="st"> </span><span class="kw">tbl</span>(sc, <span class="st">'airports'</span>)</code></pre></div>
</div>
<div id="create-a-model-data-set" class="section level2">
<h2 class="hasAnchor">
<a href="#create-a-model-data-set" class="anchor"></a>Create a model data set</h2>
<p>Filter the data to contain only the records to be used in the fitted model. Join carrier descriptions for reference. Create a new variable called <code>gain</code> which represents the amount of time gained (or lost) in flight.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Filter records and create target variable 'gain'</span>
model_data &lt;-<span class="st"> </span>flights_tbl <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">filter</span>(<span class="op">!</span><span class="kw">is.na</span>(arrdelay) <span class="op">&amp;</span><span class="st"> </span><span class="op">!</span><span class="kw">is.na</span>(depdelay) <span class="op">&amp;</span><span class="st"> </span><span class="op">!</span><span class="kw">is.na</span>(distance)) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">filter</span>(depdelay <span class="op">&gt;</span><span class="st"> </span><span class="dv">15</span> <span class="op">&amp;</span><span class="st"> </span>depdelay <span class="op">&lt;</span><span class="st"> </span><span class="dv">240</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">filter</span>(arrdelay <span class="op">&gt;</span><span class="st"> </span><span class="op">-</span><span class="dv">60</span> <span class="op">&amp;</span><span class="st"> </span>arrdelay <span class="op">&lt;</span><span class="st"> </span><span class="dv">360</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">filter</span>(year <span class="op">&gt;=</span><span class="st"> </span><span class="dv">2003</span> <span class="op">&amp;</span><span class="st"> </span>year <span class="op">&lt;=</span><span class="st"> </span><span class="dv">2007</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">left_join</span>(airlines_tbl, <span class="dt">by =</span> <span class="kw">c</span>(<span class="st">"uniquecarrier"</span> =<span class="st"> "code"</span>)) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">gain =</span> depdelay <span class="op">-</span><span class="st"> </span>arrdelay) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">select</span>(year, month, arrdelay, depdelay, distance, uniquecarrier, description, gain)

<span class="co"># Summarize data by carrier</span>
model_data <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">group_by</span>(uniquecarrier) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">summarize</span>(<span class="dt">description =</span> <span class="kw">min</span>(description), <span class="dt">gain=</span><span class="kw">mean</span>(gain), 
            <span class="dt">distance=</span><span class="kw">mean</span>(distance), <span class="dt">depdelay=</span><span class="kw">mean</span>(depdelay)) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">select</span>(description, gain, distance, depdelay) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">arrange</span>(gain)</code></pre></div>
<pre><code>Source:   query [?? x 4]
Database: spark connection master=yarn-client app=sparklyr local=FALSE

                    description       gain  distance depdelay
                          &lt;chr&gt;      &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;
1        ATA Airlines d/b/a ATA -3.3480120 1134.7084 56.06583
2  ExpressJet Airlines Inc. (1) -3.0326180  519.7125 59.41659
3                     Envoy Air -2.5434415  416.3716 53.12529
4       Northwest Airlines Inc. -2.2030586  779.2342 48.52828
5          Delta Air Lines Inc. -1.8248026  868.3997 50.77174
6   AirTran Airways Corporation -1.4331555  641.8318 54.96702
7    Continental Air Lines Inc. -0.9617003 1116.6668 57.00553
8        American Airlines Inc. -0.8860262 1074.4388 55.45045
9             Endeavor Air Inc. -0.6392733  467.1951 58.47395
10              JetBlue Airways -0.3262134 1139.0443 54.06156
# ... with more rows</code></pre>
</div>
<div id="train-a-linear-model" class="section level2">
<h2 class="hasAnchor">
<a href="#train-a-linear-model" class="anchor"></a>Train a linear model</h2>
<p>Predict time gained or lost in flight as a function of distance, departure delay, and airline carrier.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Partition the data into training and validation sets</span>
model_partition &lt;-<span class="st"> </span>model_data <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw"><a href="../reference/sdf_partition.html">sdf_partition</a></span>(<span class="dt">train =</span> <span class="fl">0.8</span>, <span class="dt">valid =</span> <span class="fl">0.2</span>, <span class="dt">seed =</span> <span class="dv">5555</span>)

<span class="co"># Fit a linear model</span>
ml1 &lt;-<span class="st"> </span>model_partition<span class="op">$</span>train <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/ml_linear_regression.html">ml_linear_regression</a></span>(gain <span class="op">~</span><span class="st"> </span>distance <span class="op">+</span><span class="st"> </span>depdelay <span class="op">+</span><span class="st"> </span>uniquecarrier)

<span class="co"># Summarize the linear model</span>
<span class="kw">summary</span>(ml1)</code></pre></div>
<pre><code>Deviance Residuals: (approximate):
     Min       1Q   Median       3Q      Max 
-305.422   -5.593    2.699    9.750  147.871 

Coefficients:
                    Estimate  Std. Error  t value  Pr(&gt;|t|)    
(Intercept)      -1.24342576  0.10248281 -12.1330 &lt; 2.2e-16 ***
distance          0.00326600  0.00001670 195.5709 &lt; 2.2e-16 ***
depdelay         -0.01466233  0.00020337 -72.0977 &lt; 2.2e-16 ***
uniquecarrier_AA -2.32650517  0.10522524 -22.1098 &lt; 2.2e-16 ***
uniquecarrier_AQ  2.98773637  0.28798507  10.3746 &lt; 2.2e-16 ***
uniquecarrier_AS  0.92054894  0.11298561   8.1475 4.441e-16 ***
uniquecarrier_B6 -1.95784698  0.11728289 -16.6934 &lt; 2.2e-16 ***
uniquecarrier_CO -2.52618081  0.11006631 -22.9514 &lt; 2.2e-16 ***
uniquecarrier_DH  2.23287189  0.11608798  19.2343 &lt; 2.2e-16 ***
uniquecarrier_DL -2.68848119  0.10621977 -25.3106 &lt; 2.2e-16 ***
uniquecarrier_EV  1.93484736  0.10724290  18.0417 &lt; 2.2e-16 ***
uniquecarrier_F9 -0.89788137  0.14422281  -6.2257 4.796e-10 ***
uniquecarrier_FL -1.46706706  0.11085354 -13.2343 &lt; 2.2e-16 ***
uniquecarrier_HA -0.14506644  0.25031456  -0.5795    0.5622    
uniquecarrier_HP  2.09354855  0.12337515  16.9690 &lt; 2.2e-16 ***
uniquecarrier_MQ -1.88297535  0.10550507 -17.8473 &lt; 2.2e-16 ***
uniquecarrier_NW -2.79538927  0.10752182 -25.9983 &lt; 2.2e-16 ***
uniquecarrier_OH  0.83520117  0.11032997   7.5700 3.730e-14 ***
uniquecarrier_OO  0.61993842  0.10679884   5.8047 6.447e-09 ***
uniquecarrier_TZ -4.99830389  0.15912629 -31.4109 &lt; 2.2e-16 ***
uniquecarrier_UA -0.68294396  0.10638099  -6.4198 1.365e-10 ***
uniquecarrier_US -0.61589284  0.10669583  -5.7724 7.815e-09 ***
uniquecarrier_WN  3.86386059  0.10362275  37.2878 &lt; 2.2e-16 ***
uniquecarrier_XE -2.59658123  0.10775736 -24.0966 &lt; 2.2e-16 ***
uniquecarrier_YV  3.11113140  0.11659679  26.6828 &lt; 2.2e-16 ***
---
Signif. codes:  0 â€˜***â€™ 0.001 â€˜**â€™ 0.01 â€˜*â€™ 0.05 â€˜.â€™ 0.1 â€˜ â€™ 1

R-Squared: 0.02385
Root Mean Squared Error: 17.74</code></pre>
</div>
<div id="assess-model-performance" class="section level2">
<h2 class="hasAnchor">
<a href="#assess-model-performance" class="anchor"></a>Assess model performance</h2>
<p>Compare the model performance using the validation data.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Calculate average gains by predicted decile</span>
model_deciles &lt;-<span class="st"> </span><span class="kw">lapply</span>(model_partition, <span class="cf">function</span>(x) {
  <span class="kw"><a href="../reference/sdf_predict.html">sdf_predict</a></span>(ml1, x) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">mutate</span>(<span class="dt">decile =</span> <span class="kw">ntile</span>(<span class="kw">desc</span>(prediction), <span class="dv">10</span>)) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">group_by</span>(decile) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">summarize</span>(<span class="dt">gain =</span> <span class="kw">mean</span>(gain)) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">select</span>(decile, gain) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">collect</span>()
})

<span class="co"># Create a summary dataset for plotting</span>
deciles &lt;-<span class="st"> </span><span class="kw">rbind</span>(
  <span class="kw">data.frame</span>(<span class="dt">data =</span> <span class="st">'train'</span>, model_deciles<span class="op">$</span>train),
  <span class="kw">data.frame</span>(<span class="dt">data =</span> <span class="st">'valid'</span>, model_deciles<span class="op">$</span>valid),
  <span class="dt">make.row.names =</span> <span class="ot">FALSE</span>
)

<span class="co"># Plot average gains by predicted decile</span>
deciles <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="kw">factor</span>(decile), gain, <span class="dt">fill =</span> data)) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_bar</span>(<span class="dt">stat =</span> <span class="st">'identity'</span>, <span class="dt">position =</span> <span class="st">'dodge'</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">labs</span>(<span class="dt">title =</span> <span class="st">'Average gain by predicted decile'</span>, <span class="dt">x =</span> <span class="st">'Decile'</span>, <span class="dt">y =</span> <span class="st">'Minutes'</span>)</code></pre></div>
<p>
<img src="images/deployment/amazon-emr/performance-1.png" width="600/"></p>
</div>
<div id="visualize-predictions" class="section level2">
<h2 class="hasAnchor">
<a href="#visualize-predictions" class="anchor"></a>Visualize predictions</h2>
<p>Compare actual gains to predicted gains for an out of time sample.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Select data from an out of time sample</span>
data_<span class="dv">2008</span> &lt;-<span class="st"> </span>flights_tbl <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">filter</span>(<span class="op">!</span><span class="kw">is.na</span>(arrdelay) <span class="op">&amp;</span><span class="st"> </span><span class="op">!</span><span class="kw">is.na</span>(depdelay) <span class="op">&amp;</span><span class="st"> </span><span class="op">!</span><span class="kw">is.na</span>(distance)) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">filter</span>(depdelay <span class="op">&gt;</span><span class="st"> </span><span class="dv">15</span> <span class="op">&amp;</span><span class="st"> </span>depdelay <span class="op">&lt;</span><span class="st"> </span><span class="dv">240</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">filter</span>(arrdelay <span class="op">&gt;</span><span class="st"> </span><span class="op">-</span><span class="dv">60</span> <span class="op">&amp;</span><span class="st"> </span>arrdelay <span class="op">&lt;</span><span class="st"> </span><span class="dv">360</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">filter</span>(year <span class="op">==</span><span class="st"> </span><span class="dv">2008</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">left_join</span>(airlines_tbl, <span class="dt">by =</span> <span class="kw">c</span>(<span class="st">"uniquecarrier"</span> =<span class="st"> "code"</span>)) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">gain =</span> depdelay <span class="op">-</span><span class="st"> </span>arrdelay) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">select</span>(year, month, arrdelay, depdelay, distance, uniquecarrier, description, gain, origin,dest)

<span class="co"># Summarize data by carrier</span>
carrier &lt;-<span class="st"> </span><span class="kw"><a href="../reference/sdf_predict.html">sdf_predict</a></span>(ml1, data_<span class="dv">2008</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">group_by</span>(description) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">summarize</span>(<span class="dt">gain =</span> <span class="kw">mean</span>(gain), <span class="dt">prediction =</span> <span class="kw">mean</span>(prediction), <span class="dt">freq =</span> <span class="kw">n</span>()) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">filter</span>(freq <span class="op">&gt;</span><span class="st"> </span><span class="dv">10000</span>) <span class="op">%&gt;%</span>
<span class="st">  </span>collect

<span class="co"># Plot actual gains and predicted gains by airline carrier</span>
<span class="kw">ggplot</span>(carrier, <span class="kw">aes</span>(gain, prediction)) <span class="op">+</span><span class="st"> </span>
<span class="st">  </span><span class="kw">geom_point</span>(<span class="dt">alpha =</span> <span class="fl">0.75</span>, <span class="dt">color =</span> <span class="st">'red'</span>, <span class="dt">shape =</span> <span class="dv">3</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_abline</span>(<span class="dt">intercept =</span> <span class="dv">0</span>, <span class="dt">slope =</span> <span class="dv">1</span>, <span class="dt">alpha =</span> <span class="fl">0.15</span>, <span class="dt">color =</span> <span class="st">'blue'</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_text</span>(<span class="kw">aes</span>(<span class="dt">label =</span> <span class="kw">substr</span>(description, <span class="dv">1</span>, <span class="dv">20</span>)), <span class="dt">size =</span> <span class="dv">3</span>, <span class="dt">alpha =</span> <span class="fl">0.75</span>, <span class="dt">vjust =</span> <span class="op">-</span><span class="dv">1</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">labs</span>(<span class="dt">title=</span><span class="st">'Average Gains Forecast'</span>, <span class="dt">x =</span> <span class="st">'Actual'</span>, <span class="dt">y =</span> <span class="st">'Predicted'</span>)</code></pre></div>
<p>
<img src="images/deployment/amazon-emr/forecast-1.png" width="600/"></p>
<p>Some carriers make up more time than others in flight, but the differences are relatively small. The average time gains between the best and worst airlines is only six minutes. The best predictor of time gained is not carrier but flight distance. The biggest gains were associated with the longest flights.</p>
</div>
</div>
<div id="share-insights" class="section level1">
<h1 class="hasAnchor">
<a href="#share-insights" class="anchor"></a>Share Insights</h1>
<p>This simple linear model contains a wealth of detailed information about carriers, distances traveled, and flight delays. These detailed insights can be conveyed to a non-technical audiance via an interactive <a href="http://rmarkdown.rstudio.com/flexdashboard/index.html">flexdashboard</a>.</p>
<div id="build-dashboard" class="section level2">
<h2 class="hasAnchor">
<a href="#build-dashboard" class="anchor"></a>Build dashboard</h2>
<p>Aggregate the scored data by origin, destination, and airline. Save the aggregated data.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Summarize by origin, destination, and carrier</span>
summary_<span class="dv">2008</span> &lt;-<span class="st"> </span><span class="kw"><a href="../reference/sdf_predict.html">sdf_predict</a></span>(ml1, data_<span class="dv">2008</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">rename</span>(<span class="dt">carrier =</span> uniquecarrier, <span class="dt">airline =</span> description) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">group_by</span>(origin, dest, carrier, airline) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">summarize</span>(
    <span class="dt">flights =</span> <span class="kw">n</span>(),
    <span class="dt">distance =</span> <span class="kw">mean</span>(distance),
    <span class="dt">avg_dep_delay =</span> <span class="kw">mean</span>(depdelay),
    <span class="dt">avg_arr_delay =</span> <span class="kw">mean</span>(arrdelay),
    <span class="dt">avg_gain =</span> <span class="kw">mean</span>(gain),
    <span class="dt">pred_gain =</span> <span class="kw">mean</span>(prediction)
    )

<span class="co"># Collect and save objects</span>
pred_data &lt;-<span class="st"> </span><span class="kw">collect</span>(summary_<span class="dv">2008</span>)
airports &lt;-<span class="st"> </span><span class="kw">collect</span>(<span class="kw">select</span>(airports_tbl, name, faa, lat, lon))
ml1_summary &lt;-<span class="st"> </span><span class="kw">capture.output</span>(<span class="kw">summary</span>(ml1))
<span class="kw">save</span>(pred_data, airports, ml1_summary, <span class="dt">file =</span> <span class="st">'flights_pred_2008.RData'</span>)</code></pre></div>
</div>
<div id="publish-dashboard" class="section level2">
<h2 class="hasAnchor">
<a href="#publish-dashboard" class="anchor"></a>Publish dashboard</h2>
Use the saved data to build an R Markdown <a href="http://rmarkdown.rstudio.com/flexdashboard/index.html">flexdashboard</a>. Publish the flexdashboard to <a href="https://www.rstudio.com/products/shiny-server-pro/">Shiny Server</a>, <a href="https://www.rstudio.com/products/shinyapps/">Shinyapps.io</a> or <a href="https://www.rstudio.com/products/connect/">RStudio Connect</a>.
<p>
<a href="https://beta.rstudioconnect.com/content/1439/"> <img src="images/deployment/amazon-emr/flightsDashboard.png" width="600/"></a>
</p>
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li>
<a href="#data-preparation">Data preparation</a><ul class="nav nav-pills nav-stacked">
<li><a href="#set-up-the-cluster">Set up the cluster</a></li>
      <li><a href="#download-flights-data">Download flights data</a></li>
      <li><a href="#create-hive-tables">Create Hive tables</a></li>
      <li><a href="#connect-to-spark">Connect to Spark</a></li>
      </ul>
</li>
      <li>
<a href="#data-analysis">Data analysis</a><ul class="nav nav-pills nav-stacked">
<li><a href="#cache-the-tables-into-memory">Cache the tables into memory</a></li>
      <li><a href="#create-a-model-data-set">Create a model data set</a></li>
      <li><a href="#train-a-linear-model">Train a linear model</a></li>
      <li><a href="#assess-model-performance">Assess model performance</a></li>
      <li><a href="#visualize-predictions">Visualize predictions</a></li>
      </ul>
</li>
      <li>
<a href="#share-insights">Share Insights</a><ul class="nav nav-pills nav-stacked">
<li><a href="#build-dashboard">Build dashboard</a></li>
      <li><a href="#publish-dashboard">Publish dashboard</a></li>
      </ul>
</li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Javier Luraschi, Kevin Ushey, JJ Allaire,  The Apache Software Foundation.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://hadley.github.io/pkgdown/">pkgdown</a>.</p>
</div>

      </footer>
</div>

  </body>
</html>
